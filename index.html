<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>App de Guincho - Solicitação de Serviço</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    body {
      background-color: #f5f5f5;
      padding: 10px;
      font-size: 14px;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    header img {
      max-width: 150px;
      height: auto;
    }
    h3 {
      font-size: 1.2em;
      margin: 15px 0 10px;
      color: #333;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1em;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border-radius: 8px;
      position: relative;
    }
    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5em;
      cursor: pointer;
    }
    .request-item {
      display: flex;
      flex-direction: column;
      padding: 10px;
      border-bottom: 1px solid #eee;
      background-color: white;
      border-radius: 5px;
      margin-bottom: 5px;
    }
    .request-item span {
      margin-bottom: 5px;
    }
    .request-item button, .request-item a {
      padding: 8px;
      font-size: 0.9em;
      margin-top: 5px;
      text-decoration: none;
      color: white;
      background-color: #28a745;
      border-radius: 5px;
      display: inline-block;
      width: auto;
    }
    .request-item a {
      background-color: #17a2b8;
    }
    .request-item a:hover {
      background-color: #138496;
    }
    .request-item button {
      background-color: #007bff;
    }
    .hidden-section {
      display: none !important;
    }
    .note {
      color: #ff0000;
      font-size: 0.9em;
      margin: 5px 0;
    }
    @media (max-width: 600px) {
      body {
        padding: 5px;
        font-size: 12px;
      }
      h3 {
        font-size: 1.1em;
      }
      input, select, button, textarea {
        font-size: 0.9em;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h2>App de Guincho</h2>
  </header>
  <div id="authSection">
    <h3>Login / Cadastro</h3>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Senha">
    <select id="userType">
      <option value="cliente">Cliente</option>
      <option value="motorista">Motorista</option>
    </select>
    <button id="registerBtn">Cadastrar</button>
    <button id="loginBtn">Entrar</button>
  </div>
  <div id="appSection" style="display:none;">
    <button id="logoutBtn">Sair</button>
    <hr>
    <div id="typeSelection" style="display:none;">
      <h3>Selecione seu tipo de usuário</h3>
      <select id="selectUserType">
        <option value="cliente">Cliente</option>
        <option value="motorista">Motorista</option>
      </select>
      <button id="saveUserTypeBtn">Salvar</button>
    </div>
    <div id="clientSection" style="display:none;">
      <h3>Solicitar Guincho</h3>
      <textarea id="description" placeholder="Descreva o problema (ex: carro quebrou, pneu furado)"></textarea>
      <p class="note">Nota: Para usar a localização GPS, o app deve ser servido via HTTPS (não HTTP ou file://). Em localhost pode funcionar para testes. Consulte https://goo.gl/Y0ZkNV para mais detalhes.</p>
      <button id="getLocationBtn">Obter Localização GPS</button>
      <p id="locationStatus">Localização: Não obtida</p>
      <button id="requestTowBtn" disabled>Solicitar Guincho</button>
      <hr>
      <h3>Suas Solicitações</h3>
      <div id="clientRequestsList">
        <p>Carregando...</p>
      </div>
    </div>
    <div id="driverSection" style="display:none;">
      <h3>Solicitações Pendentes</h3>
      <div id="pendingRequestsList">
        <p>Carregando...</p>
      </div>
      <hr>
      <h3>Suas Solicitações Aceitas</h3>
      <div id="driverAcceptedList">
        <p>Carregando...</p>
      </div>
    </div>
  </div>
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <span class="close-button">×</span>
      <h3>Confirmação</h3>
      <p id="modalMessage"></p>
      <button id="confirmActionBtn">Confirmar</button>
    </div>
  </div>
  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      update,
      onValue,
      remove
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyDJBdK9I-jtg9ujTc9Xsxr-hnPfkId4wIU",
      authDomain: "pdv1-77632.firebaseapp.com",
      databaseURL: "https://pdv1-77632-default-rtdb.firebaseio.com",
      projectId: "pdv1-77632",
      storageBucket: "pdv1-77632.firebasestorage.app",
      messagingSenderId: "246033791117",
      appId: "1:246033791117:web:7b70b511ea8d8c5ba1cac4",
      measurementId: "G-NTG13SG6VM"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();
    let currentLocation = null;
    let userType = null;
    let currentUserUid = null;
    let editId = null;

    // Autenticação
    document.getElementById("registerBtn").onclick = () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const type = document.getElementById("userType").value;
      createUserWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          const user = userCredential.user;
          set(ref(db, `users/${user.uid}`), { type });
          alert("Usuário registrado como " + type + "!");
        })
        .catch(err => alert(err.message));
    };
    document.getElementById("loginBtn").onclick = () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => alert("Login realizado!"))
        .catch(err => alert(err.message));
    };
    document.getElementById("logoutBtn").onclick = () => {
      signOut(auth);
    };
    onAuthStateChanged(auth, user => {
      if (user) {
        currentUserUid = user.uid;
        document.getElementById("authSection").style.display = "none";
        document.getElementById("appSection").style.display = "block";
        loadUserType(user.uid);
      } else {
        document.getElementById("authSection").style.display = "block";
        document.getElementById("appSection").style.display = "none";
      }
    });

    function loadUserType(uid) {
      const userRef = ref(db, `users/${uid}`);
      onValue(userRef, snapshot => {
        if (snapshot.exists()) {
          userType = snapshot.val().type;
          if (userType) {
            document.getElementById("typeSelection").style.display = "none";
            document.getElementById("clientSection").style.display = userType === "cliente" ? "block" : "none";
            document.getElementById("driverSection").style.display = userType === "motorista" ? "block" : "none";
            if (userType === "cliente") {
              loadClientRequests(uid);
            } else if (userType === "motorista") {
              loadPendingRequests();
              loadDriverAcceptedRequests(uid);
            }
          } else {
            document.getElementById("typeSelection").style.display = "block";
            document.getElementById("clientSection").style.display = "none";
            document.getElementById("driverSection").style.display = "none";
          }
        } else {
          document.getElementById("typeSelection").style.display = "block";
          document.getElementById("clientSection").style.display = "none";
          document.getElementById("driverSection").style.display = "none";
        }
      }, { onlyOnce: false });
    }

    document.getElementById("saveUserTypeBtn").onclick = () => {
      const type = document.getElementById("selectUserType").value;
      set(ref(db, `users/${currentUserUid}`), { type })
        .then(() => {
          alert("Tipo de usuário salvo como " + type + "!");
          userType = type;
          document.getElementById("typeSelection").style.display = "none";
          if (type === "cliente") {
            document.getElementById("clientSection").style.display = "block";
            loadClientRequests(currentUserUid);
          } else if (type === "motorista") {
            document.getElementById("driverSection").style.display = "block";
            loadPendingRequests();
            loadDriverAcceptedRequests(currentUserUid);
          }
        })
        .catch(err => alert("Erro ao salvar tipo: " + err.message));
    };

    // Funções para Cliente
    document.getElementById("getLocationBtn").onclick = () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          currentLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
          document.getElementById("locationStatus").textContent = `Localização: Lat ${currentLocation.lat.toFixed(4)}, Lng ${currentLocation.lng.toFixed(4)}`;
          document.getElementById("requestTowBtn").disabled = false;
        }, err => {
          alert(`Erro ao obter localização: ${err.message}. Certifique-se de que o app está sendo servido via HTTPS.`);
        });
      } else {
        alert("Geolocalização não suportada.");
      }
    };

    document.getElementById("requestTowBtn").onclick = () => {
      const description = document.getElementById("description").value.trim();
      if (!currentLocation || !description) {
        alert("Obtenha a localização e descreva o problema.");
        return;
      }
      const requestData = {
        clientId: currentUserUid,
        location: currentLocation,
        description,
        status: "pending",
        driverId: null,
        timestamp: new Date().toISOString()
      };
      const requestsRef = push(ref(db, "requests"));
      set(requestsRef, requestData)
        .then(() => {
          alert("Solicitação enviada!");
          document.getElementById("description").value = "";
          currentLocation = null;
          document.getElementById("locationStatus").textContent = "Localização: Não obtida";
          document.getElementById("requestTowBtn").disabled = true;
        })
        .catch(err => alert("Erro ao enviar solicitação: " + err.message));
    };

    function loadClientRequests(uid) {
      const requestsRef = ref(db, "requests");
      onValue(requestsRef, snapshot => {
        const requests = snapshot.val() || {};
        const clientRequests = Object.entries(requests).filter(([_, req]) => req.clientId === uid);
        const listDiv = document.getElementById("clientRequestsList");
        listDiv.innerHTML = clientRequests.length === 0 ? "<p>Nenhuma solicitação.</p>" : clientRequests.map(([id, req]) => `
          <div class="request-item">
            <span>${new Date(req.timestamp).toLocaleString('pt-BR')} - ${req.description} - Status: ${req.status}</span>
            ${req.status === "pending" ? `<button onclick="cancelRequest('${id}')">Cancelar</button>` : ''}
          </div>
        `).join('');
      });
    }

    window.cancelRequest = id => {
      if (confirm("Cancelar esta solicitação?")) {
        remove(ref(db, `requests/${id}`))
          .then(() => alert("Solicitação cancelada!"))
          .catch(err => alert("Erro: " + err.message));
      }
    };

    // Funções para Motorista
    function loadPendingRequests() {
      const requestsRef = ref(db, "requests");
      onValue(requestsRef, snapshot => {
        const requests = snapshot.val() || {};
        const pending = Object.entries(requests).filter(([_, req]) => req.status === "pending");
        const listDiv = document.getElementById("pendingRequestsList");
        listDiv.innerHTML = pending.length === 0 ? "<p>Nenhuma solicitação pendente.</p>" : pending.map(([id, req]) => `
          <div class="request-item">
            <span>${new Date(req.timestamp).toLocaleString('pt-BR')} - ${req.description} - Lat: ${req.location.lat.toFixed(4)}, Lng: ${req.location.lng.toFixed(4)}</span>
            <a href="https://www.google.com/maps/search/?api=1&query=${req.location.lat},${req.location.lng}" target="_blank">Ver no Google Maps</a>
            <button onclick="acceptRequest('${id}')">Aceitar</button>
          </div>
        `).join('');
      });
    }

    function loadDriverAcceptedRequests(uid) {
      const requestsRef = ref(db, "requests");
      onValue(requestsRef, snapshot => {
        const requests = snapshot.val() || {};
        const accepted = Object.entries(requests).filter(([_, req]) => req.driverId === uid && req.status === "accepted");
        const listDiv = document.getElementById("driverAcceptedList");
        listDiv.innerHTML = accepted.length === 0 ? "<p>Nenhuma solicitação aceita.</p>" : accepted.map(([id, req]) => `
          <div class="request-item">
            <span>${new Date(req.timestamp).toLocaleString('pt-BR')} - ${req.description} - Lat: ${req.location.lat.toFixed(4)}, Lng: ${req.location.lng.toFixed(4)}</span>
            <a href="https://www.google.com/maps/search/?api=1&query=${req.location.lat},${req.location.lng}" target="_blank">Ver no Google Maps</a>
            <button onclick="completeRequest('${id}')">Concluir</button>
          </div>
        `).join('');
      });
    }

    window.acceptRequest = id => {
      if (confirm("Aceitar esta solicitação?")) {
        update(ref(db, `requests/${id}`), { status: "accepted", driverId: currentUserUid })
          .then(() => alert("Solicitação aceita!"))
          .catch(err => alert("Erro: " + err.message));
      }
    };

    window.completeRequest = id => {
      if (confirm("Concluir esta solicitação?")) {
        update(ref(db, `requests/${id}`), { status: "completed" })
          .then(() => alert("Solicitação concluída!"))
          .catch(err => alert("Erro: " + err.message));
      }
    };

    // Modal genérico
    document.querySelector(".close-button").onclick = () => {
      document.getElementById("confirmModal").style.display = "none";
    };
  </script>
</body>
</html>
